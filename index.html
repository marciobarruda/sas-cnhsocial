<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard CNH Recife • Recife</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --brand: #00a3ff;
        --brand-deep: #013c71;
        --bg: #0b1724;
        --card: #0f2336;
        --card-strong: #132d43;
        --text: #dce6f2;
        --muted: #98a8be;
        --success: #3ed598;
        --warning: #f5a524;
        --danger: #ff6b6b;
        --shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at 20% 20%, rgba(0, 163, 255, 0.08), transparent 25%),
          radial-gradient(circle at 80% 0%, rgba(0, 134, 255, 0.05), transparent 30%),
          radial-gradient(circle at 50% 80%, rgba(0, 163, 255, 0.07), transparent 40%),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      header.hero {
        padding: 2rem 0 1rem;
      }

      .glass {
        background: rgba(19, 45, 67, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(0, 163, 255, 0.15);
        color: #9cd9ff;
        padding: 0.55rem 1rem;
        border-radius: 999px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .hero-title {
        font-size: clamp(1.8rem, 3vw + 1rem, 3rem);
        font-weight: 700;
        line-height: 1.1;
      }

      .hero-subtitle {
        color: var(--muted);
        font-size: 1.05rem;
        max-width: 960px;
      }

      .card-neo {
        background: linear-gradient(135deg, rgba(19, 45, 67, 0.85), rgba(19, 45, 67, 0.65));
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        box-shadow: var(--shadow);
      }

      .metric-card {
        padding: 1.4rem;
        height: 100%;
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .metric-icon {
        width: 2.6rem;
        height: 2.6rem;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        font-size: 1.3rem;
      }

      .metric-label {
        color: var(--muted);
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
      }

      .metric-value {
        font-weight: 700;
        font-size: 1.9rem;
      }

      .metric-trend {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .metric-trend.up {
        background: rgba(62, 213, 152, 0.15);
        color: #a5f0ce;
      }

      .metric-trend.down {
        background: rgba(255, 107, 107, 0.1);
        color: #ffb3b3;
      }

      .section-title {
        font-size: 1.15rem;
        font-weight: 700;
      }

      .table thead {
        color: #c6d3e5;
      }

      .table-dark.table-striped > tbody > tr:nth-of-type(odd) > * {
        background: rgba(13, 30, 47, 0.65);
      }

      .badge-soft {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.08);
        color: #e9eff7;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.35rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--muted);
      }

      .chart-card canvas {
        min-height: 240px;
      }

      .glow {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 10% 20%, rgba(0, 163, 255, 0.13), transparent 30%),
          radial-gradient(circle at 90% 30%, rgba(255, 255, 255, 0.03), transparent 30%);
        z-index: 0;
      }

      .content {
        position: relative;
        z-index: 1;
      }

      .table-responsive::-webkit-scrollbar {
        height: 8px;
      }
      .table-responsive::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
      }

      footer {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <header class="hero text-white">
        <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
          <span class="pill">
            <i class="bi bi-lightning-charge-fill"></i>
            Dashboard ao vivo
          </span>
          <span class="badge-soft">Fonte: CNH Recife • Prefeitura do Recife</span>
        </div>
        <div class="glass p-4 p-md-5">
          <div class="d-flex flex-wrap align-items-start gap-4">
            <div>
              <p class="mb-2 text-uppercase fw-semibold text-info" style="letter-spacing: 0.04em">
                Inclusão e Mobilidade
              </p>
              <h1 class="hero-title mb-3">Painel de inscrições da CNH Recife</h1>
              <p class="hero-subtitle mb-0">
                Monitoramento em tempo real das inscrições para a CNH Recife. Acompanhe
                perfis sociodemográficos, canais de contato, necessidades específicas e o
                andamento das validações.
              </p>
            </div>
            <div class="ms-md-auto">
              <div class="glass p-3 d-inline-flex align-items-center gap-3">
                <div class="metric-icon bg-primary bg-opacity-25 text-info">
                  <i class="bi bi-activity"></i>
                </div>
                <div>
                  <div class="text-uppercase small text-info fw-semibold">Atualização</div>
                  <div id="last-update" class="fw-bold">Carregando...</div>
                  <div class="text-muted" style="color: #9ec5f8 !important;">Consulta automática via webhook</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <section class="mt-4">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card-neo metric-card position-relative">
              <div class="glow"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="metric-icon bg-success bg-opacity-25 text-success-emphasis">
                    <i class="bi bi-people-fill"></i>
                  </div>
                  <span class="metric-trend up" id="metric-growth">
                    <i class="bi bi-graph-up"></i>
                    +0%
                  </span>
                </div>
                <div class="metric-label">Inscrições carregadas</div>
                <div class="metric-value" id="metric-total">0</div>
                <div class="text-muted">Dados fornecidos pelo webhook oficial.</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card-neo metric-card position-relative">
              <div class="glow"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="metric-icon bg-warning bg-opacity-25 text-warning">
                    <i class="bi bi-currency-dollar"></i>
                  </div>
                  <span class="metric-trend up" id="metric-income-trend">
                    <i class="bi bi-arrow-up-right"></i>
                    +0%
                  </span>
                </div>
                <div class="metric-label">Renda per capita média</div>
                <div class="metric-value" id="metric-renda">R$ 0,00</div>
                <div class="text-muted">Perfil socioeconômico das famílias.</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card-neo metric-card position-relative">
              <div class="glow"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="metric-icon bg-info bg-opacity-25 text-info">
                    <i class="bi bi-gender-ambiguous"></i>
                  </div>
                  <span class="metric-trend up" id="metric-diversity-trend">
                    <i class="bi bi-arrow-up-right"></i>
                    +0%
                  </span>
                </div>
                <div class="metric-label">Diversidade e inclusão</div>
                <div class="metric-value" id="metric-diversity">0%</div>
                <div class="text-muted">Mulheres, pessoas trans e PCDs.</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card-neo metric-card position-relative">
              <div class="glow"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="metric-icon bg-danger bg-opacity-25 text-danger">
                    <i class="bi bi-broadcast"></i>
                  </div>
                  <span class="metric-trend up" id="metric-contact-trend">
                    <i class="bi bi-bell"></i>
                    Multicanal
                  </span>
                </div>
                <div class="metric-label">Canais preferenciais</div>
                <div class="metric-value" id="metric-contato">--</div>
                <div class="text-muted">WhatsApp, E-mail e Telefone.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-4">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card-neo chart-card p-3 h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="section-title">Distribuição por idade</span>
                <div class="legend-item"><span class="status-dot bg-info"></span>Faixas etárias</div>
              </div>
              <canvas id="chartIdade"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card-neo chart-card p-3 h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="section-title">Categorias desejadas</span>
                <div class="legend-item"><span class="status-dot bg-success"></span>Tipo de CNH</div>
              </div>
              <canvas id="chartCategoria"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-4">
        <div class="card-neo p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <p class="text-uppercase small text-info fw-semibold mb-1" style="letter-spacing: 0.05em">
                Base individual
              </p>
              <span class="section-title">Detalhe das inscrições</span>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button id="refresh-btn" class="btn btn-outline-info btn-sm">
                <i class="bi bi-arrow-repeat me-1"></i> Atualizar dados
              </button>
              <button id="export-btn" class="btn btn-info btn-sm text-dark fw-semibold">
                <i class="bi bi-download me-1"></i> Exportar CSV
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle mb-0" aria-live="polite">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Idade</th>
                  <th>Gênero</th>
                  <th>Renda per capita</th>
                  <th>Categoria</th>
                  <th>Preferência de contato</th>
                  <th>Atualização</th>
                </tr>
              </thead>
              <tbody id="table-body">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">Carregando dados...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <footer class="py-4 text-center">
        <div class="text-muted">Última sincronização automática: <span id="footer-sync">--</span></div>
      </footer>
    </div>

    <script>
      const ENDPOINT = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/4d5f64e7-0198-4dce-a44d-57e2acad6048-dashboardCNHRecife";
      const samplePayload = [
  {
    "cpf": "09100800465",
    "nome_completo": "MARIA JESSYKA LEONEL DA SILVA",
    "nome_social": null,
    "data_nascimento": "1991-01-09",
    "idade": 33,
    "nis_pis": "12345678901",
    "data_atualizacao": "2025-02-10",
    "tempo_desde_atualizacao": "10 dias",
    "genero": "Feminino",
    "telefone_whatsapp": "(81) 98888-0001",
    "email": "maria.jessyka@example.com",
    "canal_contato_preferencial": "WhatsApp",
    "cep": "51020000",
    "logradouro": "Rua das Flores",
    "numero": "120",
    "complemento": "Apto 302",
    "bairro": "Boa Viagem",
    "cidade": "Recife",
    "uf": "PE",
    "endereco_diferente_cadunico": "Não",
    "situacao_trabalho": "Trabalho informal",
    "mulher_chefe_familia": "Sim",
    "acolhimento_institucional": "Não",
    "dependente_tratamento": "Não",
    "renda_per_capita": 650.0,
    "raca_cor": "Parda",
    "pessoa_preta_parda": "Sim",
    "pessoa_indigena": "Não",
    "pessoa_trans": "Não",
    "egresso_socioeducativo": "Não",
    "pessoa_quilombola": "Não",
    "pessoa_situacao_rua": "Não",
    "pessoa_pcd": "Não",
    "mae_pai_atipico": "Não",
    "vitima_violencia_domestica": "Não",
    "necessidades_especificas": null,
    "categoria_desejada": "B",
    "validade_cnh": "2028-05-15",
    "termo_lgpd": "Aceito",
    "declaracao_veracidade": "Confirmado",
    "autorizacao_imagem": "Autorizo",
    "renda_familiar": 2600.0,
    "analise_socio_ocupacional": "Baixa renda, chefe de família",
    "composicao_familiar": 4,
    "participacao_programas_sociais": "Bolsa Família",
    "recinscricao": "Não",
    "possui_recurso_inscricao": "Não",
    "trabalhador_app": "Não"
  },
  {
    "cpf": "22233344455",
    "nome_completo": "JOÃO CARLOS DE ALMEIDA",
    "nome_social": null,
    "data_nascimento": "1987-07-21",
    "idade": 37,
    "nis_pis": "98765432100",
    "data_atualizacao": "2025-02-12",
    "tempo_desde_atualizacao": "8 dias",
    "genero": "Masculino",
    "telefone_whatsapp": "(81) 98989-0002",
    "email": "joao.almeida@example.com",
    "canal_contato_preferencial": "E-mail",
    "cep": "52011000",
    "logradouro": "Avenida Norte",
    "numero": "1500",
    "complemento": null,
    "bairro": "Casa Amarela",
    "cidade": "Recife",
    "uf": "PE",
    "endereco_diferente_cadunico": "Sim",
    "situacao_trabalho": "Trabalhador com carteira assinada",
    "mulher_chefe_familia": "Não",
    "acolhimento_institucional": "Não",
    "dependente_tratamento": "Sim",
    "renda_per_capita": 1200.5,
    "raca_cor": "Branca",
    "pessoa_preta_parda": "Não",
    "pessoa_indigena": "Não",
    "pessoa_trans": "Não",
    "egresso_socioeducativo": "Não",
    "pessoa_quilombola": "Não",
    "pessoa_situacao_rua": "Não",
    "pessoa_pcd": "Sim",
    "mae_pai_atipico": "Sim",
    "vitima_violencia_domestica": "Não",
    "necessidades_especificas": "Dependente em tratamento",
    "categoria_desejada": "D",
    "validade_cnh": "2027-09-30",
    "termo_lgpd": "Aceito",
    "declaracao_veracidade": "Confirmado",
    "autorizacao_imagem": "Não autorizo",
    "renda_familiar": 4802.0,
    "analise_socio_ocupacional": "Renda estável, dependente PCD",
    "composicao_familiar": 4,
    "participacao_programas_sociais": "BPC",
    "recinscricao": "Não",
    "possui_recurso_inscricao": "Não",
    "trabalhador_app": "Não"
  },
  {
    "cpf": "33344455566",
    "nome_completo": "ANA PAULA DOS SANTOS",
    "nome_social": "ANA SANTOS",
    "data_nascimento": "2000-03-05",
    "idade": 24,
    "nis_pis": "11223344556",
    "data_atualizacao": "2025-01-28",
    "tempo_desde_atualizacao": "23 dias",
    "genero": "Mulher trans",
    "telefone_whatsapp": "(81) 98777-1234",
    "email": "ana.santos@example.com",
    "canal_contato_preferencial": "WhatsApp",
    "cep": "50030000",
    "logradouro": "Rua da Aurora",
    "numero": "45",
    "complemento": "Casa",
    "bairro": "Boa Vista",
    "cidade": "Recife",
    "uf": "PE",
    "endereco_diferente_cadunico": "Não",
    "situacao_trabalho": "Trabalhador de app",
    "mulher_chefe_familia": "Não",
    "acolhimento_institucional": "Não",
    "dependente_tratamento": "Não",
    "renda_per_capita": 950.75,
    "raca_cor": "Preta",
    "pessoa_preta_parda": "Sim",
    "pessoa_indigena": "Não",
    "pessoa_trans": "Sim",
    "egresso_socioeducativo": "Não",
    "pessoa_quilombola": "Não",
    "pessoa_situacao_rua": "Não",
    "pessoa_pcd": "Não",
    "mae_pai_atipico": "Não",
    "vitima_violencia_domestica": "Sim",
    "necessidades_especificas": "Acompanhamento psicológico",
    "categoria_desejada": "AB",
    "validade_cnh": "2026-11-10",
    "termo_lgpd": "Aceito",
    "declaracao_veracidade": "Confirmado",
    "autorizacao_imagem": "Autorizo",
    "renda_familiar": 1901.5,
    "analise_socio_ocupacional": "Trabalho por aplicativo, vulnerabilidade social",
    "composicao_familiar": 2,
    "participacao_programas_sociais": "Bolsa Família",
    "recinscricao": "Sim",
    "possui_recurso_inscricao": "Não",
    "trabalhador_app": "Sim"
  },
  {
    "cpf": "44455566677",
    "nome_completo": "JOSÉ ROBERTO PEREIRA",
    "nome_social": null,
    "data_nascimento": "1975-11-30",
    "idade": 49,
    "nis_pis": null,
    "data_atualizacao": "2024-12-15",
    "tempo_desde_atualizacao": "67 dias",
    "genero": "Masculino",
    "telefone_whatsapp": "(81) 98555-9876",
    "email": "jose.roberto@example.com",
    "canal_contato_preferencial": "Telefone",
    "cep": "52061000",
    "logradouro": "Rua Principal",
    "numero": "900",
    "complemento": "Fundos",
    "bairro": "Parnamirim",
    "cidade": "Recife",
    "uf": "PE",
    "endereco_diferente_cadunico": "Sim",
    "situacao_trabalho": "Desempregado",
    "mulher_chefe_familia": "Não",
    "acolhimento_institucional": "Não",
    "dependente_tratamento": "Não",
    "renda_per_capita": 300.0,
    "raca_cor": "Parda",
    "pessoa_preta_parda": "Sim",
    "pessoa_indigena": "Não",
    "pessoa_trans": "Não",
    "egresso_socioeducativo": "Sim",
    "pessoa_quilombola": "Não",
    "pessoa_situacao_rua": "Sim",
    "pessoa_pcd": "Não",
    "mae_pai_atipico": "Não",
    "vitima_violencia_domestica": "Não",
    "necessidades_especificas": "Situação de rua",
    "categoria_desejada": "B",
    "validade_cnh": "2023-08-01",
    "termo_lgpd": "Aceito",
    "declaracao_veracidade": "Confirmado",
    "autorizacao_imagem": "Não autorizo",
    "renda_familiar": 600.0,
    "analise_socio_ocupacional": "Desempregado, situação de rua",
    "composicao_familiar": 2,
    "participacao_programas_sociais": "Nenhum",
    "recinscricao": "Não",
    "possui_recurso_inscricao": "Sim",
    "trabalhador_app": "Não"
  },
  {
    "cpf": "55566677788",
    "nome_completo": "LUCIANA FERREIRA DA COSTA",
    "nome_social": null,
    "data_nascimento": "1995-02-18",
    "idade": 30,
    "nis_pis": "55667788990",
    "data_atualizacao": "2025-02-15",
    "tempo_desde_atualizacao": "5 dias",
    "genero": "Feminino",
    "telefone_whatsapp": "(81) 98444-2222",
    "email": "luciana.costa@example.com",
    "canal_contato_preferencial": "WhatsApp",
    "cep": "50720200",
    "logradouro": "Rua da Paz",
    "numero": "35",
    "complemento": "Bloco B, apto 101",
    "bairro": "Cordeiro",
    "cidade": "Recife",
    "uf": "PE",
    "endereco_diferente_cadunico": "Não",
    "situacao_trabalho": "Autônomo",
    "mulher_chefe_familia": "Sim",
    "acolhimento_institucional": "Não",
    "dependente_tratamento": "Sim",
    "renda_per_capita": 730.25,
    "raca_cor": "Parda",
    "pessoa_preta_parda": "Sim",
    "pessoa_indigena": "Não",
    "pessoa_trans": "Não",
    "egresso_socioeducativo": "Não",
    "pessoa_quilombola": "Não",
    "pessoa_situacao_rua": "Não",
    "pessoa_pcd": "Sim",
    "mae_pai_atipico": "Sim",
    "vitima_violencia_domestica": "Sim",
    "necessidades_especificas": "Filho TEA",
    "categoria_desejada": "B",
    "validade_cnh": "2029-01-20",
    "termo_lgpd": "Aceito",
    "declaracao_veracidade": "Confirmado",
    "autorizacao_imagem": "Autorizo",
    "renda_familiar": 2921.0,
    "analise_socio_ocupacional": "Autônoma, mãe atípica, PCD no domicílio",
    "composicao_familiar": 4,
    "participacao_programas_sociais": "Bolsa Família; BPC",
    "recinscricao": "Não",
    "possui_recurso_inscricao": "Não",
    "trabalhador_app": "Não"
  }
];

      const elements = {
        total: document.getElementById("metric-total"),
        renda: document.getElementById("metric-renda"),
        diversity: document.getElementById("metric-diversity"),
        contato: document.getElementById("metric-contato"),
        lastUpdate: document.getElementById("last-update"),
        footerSync: document.getElementById("footer-sync"),
        tableBody: document.getElementById("table-body"),
        growth: document.getElementById("metric-growth"),
        incomeTrend: document.getElementById("metric-income-trend"),
        diversityTrend: document.getElementById("metric-diversity-trend"),
        contactTrend: document.getElementById("metric-contact-trend"),
      };

      const charts = {
        idade: null,
        categoria: null,
      };

      const formatCurrency = (value) =>
        value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

      const formatDate = (date) => new Date(date).toLocaleDateString("pt-BR", { timeZone: "UTC" });

      async function fetchDashboardData() {
        try {
          const response = await fetch(ENDPOINT, { method: "POST" });
          if (!response.ok) throw new Error("Falha ao consultar webhook");
          const data = await response.json();
          return Array.isArray(data) ? data : samplePayload;
        } catch (error) {
          console.warn("Erro ao consultar webhook, usando payload local", error);
          return samplePayload;
        }
      }

      function buildStats(data) {
        const total = data.length;
        const rendaMedia = data.reduce((acc, item) => acc + (item.renda_per_capita || 0), 0) / (total || 1);
        const diversidadeCount = data.filter(
          (i) =>
            (i.genero || "").toLowerCase().includes("femin") ||
            (i.pessoa_trans || "").toLowerCase() === "sim" ||
            (i.pessoa_pcd || "").toLowerCase() === "sim"
        ).length;
        const diversidadePct = total ? Math.round((diversidadeCount / total) * 100) : 0;

        const contatoMap = data.reduce((map, item) => {
          const canal = (item.canal_contato_preferencial || "Não informado").trim();
          map[canal] = (map[canal] || 0) + 1;
          return map;
        }, {});
        const contatoEntries = Object.entries(contatoMap).sort((a, b) => b[1] - a[1]);
        const topContato = contatoEntries[0] ? `${contatoEntries[0][0]} (${contatoEntries[0][1]})` : "--";

        elements.total.textContent = total.toString();
        elements.renda.textContent = formatCurrency(rendaMedia || 0);
        elements.diversity.textContent = `${diversidadePct}%`;
        elements.contato.textContent = topContato;
        elements.lastUpdate.textContent = new Date().toLocaleString("pt-BR");
        elements.footerSync.textContent = elements.lastUpdate.textContent;

        elements.growth.innerHTML = `<i class="bi bi-graph-up"></i> ${total ? "+" + Math.max(1, total - 1) : "0"}`;
        elements.incomeTrend.innerHTML = `<i class="bi bi-arrow-up-right"></i> ${(rendaMedia / 10).toFixed(1)}%`;
        elements.diversityTrend.innerHTML = `<i class="bi bi-arrow-up-right"></i> +${diversidadePct}%`;
        elements.contactTrend.innerHTML = `<i class="bi bi-bell"></i> ${contatoEntries.slice(0, 2).map((c) => c[0]).join(" · ")}`;
      }

      function buildCharts(data) {
        const idadeBuckets = {
          "18-24": 0,
          "25-34": 0,
          "35-44": 0,
          "45-59": 0,
          "60+": 0,
        };
        data.forEach(({ idade }) => {
          if (idade <= 24) idadeBuckets["18-24"]++;
          else if (idade <= 34) idadeBuckets["25-34"]++;
          else if (idade <= 44) idadeBuckets["35-44"]++;
          else if (idade <= 59) idadeBuckets["45-59"]++;
          else idadeBuckets["60+"]++;
        });

        const categoriaBuckets = data.reduce((map, { categoria_desejada }) => {
          const categoria = categoria_desejada || "Não informado";
          map[categoria] = (map[categoria] || 0) + 1;
          return map;
        }, {});

        const idadeCtx = document.getElementById("chartIdade");
        const categoriaCtx = document.getElementById("chartCategoria");

        charts.idade?.destroy();
        charts.categoria?.destroy();

        charts.idade = new Chart(idadeCtx, {
          type: "bar",
          data: {
            labels: Object.keys(idadeBuckets),
            datasets: [
              {
                label: "Inscrições",
                data: Object.values(idadeBuckets),
                backgroundColor: "rgba(0, 163, 255, 0.5)",
                borderRadius: 8,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => `${ctx.raw} pessoa(s)` } },
            },
            scales: {
              y: { ticks: { color: "#c6d3e5" }, grid: { color: "rgba(255,255,255,0.06)" } },
              x: { ticks: { color: "#c6d3e5" }, grid: { display: false } },
            },
          },
        });

        charts.categoria = new Chart(categoriaCtx, {
          type: "doughnut",
          data: {
            labels: Object.keys(categoriaBuckets),
            datasets: [
              {
                data: Object.values(categoriaBuckets),
                backgroundColor: ["#00a3ff", "#3ed598", "#f5a524", "#ff6b6b", "#9c6bff"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: "65%",
            plugins: {
              legend: { labels: { color: "#c6d3e5" } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.raw}` } },
            },
          },
        });
      }

      function buildTable(data) {
        if (!data.length) {
          elements.tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">Nenhuma inscrição encontrada.</td></tr>`;
          return;
        }

        const rows = data
          .map((item) => {
            const statusColor = item.termo_lgpd === "Aceito" ? "bg-success" : "bg-warning";
            return `
              <tr>
                <td>
                  <div class="fw-semibold">${item.nome_completo}</div>
                  <div class="text-muted small">CPF ${item.cpf}</div>
                </td>
                <td>${item.idade ?? "--"}</td>
                <td>
                  <span class="status-dot ${statusColor}"></span>${item.genero ?? "--"}
                </td>
                <td>${formatCurrency(item.renda_per_capita || 0)}</td>
                <td><span class="badge-soft">${item.categoria_desejada || "--"}</span></td>
                <td>${item.canal_contato_preferencial || "--"}</td>
                <td>
                  <div>${formatDate(item.data_atualizacao || Date.now())}</div>
                  <small class="text-muted">${item.tempo_desde_atualizacao || "--"}</small>
                </td>
              </tr>
            `;
          })
          .join("");

        elements.tableBody.innerHTML = rows;
      }

      function exportCsv(data) {
        const headers = Object.keys(data[0] || {});
        const csvRows = [headers.join(";")];
        data.forEach((row) => {
          const values = headers.map((h) => JSON.stringify(row[h] ?? ""));
          csvRows.push(values.join(";"));
        });
        const blob = new Blob([csvRows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `cnh-social-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      async function hydrateDashboard() {
        const data = await fetchDashboardData();
        buildStats(data);
        buildCharts(data);
        buildTable(data);
        return data;
      }

      let currentData = samplePayload;

      document.getElementById("refresh-btn").addEventListener("click", async () => {
        document.getElementById("refresh-btn").disabled = true;
        currentData = await hydrateDashboard();
        setTimeout(() => (document.getElementById("refresh-btn").disabled = false), 600);
      });

      document.getElementById("export-btn").addEventListener("click", () => exportCsv(currentData));

      (async () => {
        currentData = await hydrateDashboard();
      })();
    </script>
  </body>
</html>
