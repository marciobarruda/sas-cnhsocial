<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CNH Recife | Painel Din√¢mico</title>
  <link rel="icon" type="image/png" href="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  
  <style>
    :root {
      /* Paleta oficial (AF_NovoManual_de_Marca_PCR_2025.pdf) */
      --brand-primary: #002776;   /* Azul prim√°rio */
      --brand-secondary: #005ca9; /* Azul secund√°rio */
      --brand-highlight: #00c8f0; /* Ciano de destaque */
      --brand-amber: #ffb81c;     /* Amarelo institucional */
      --bg-dark: #0a1733;
      --card-dark: rgba(0, 44, 102, 0.82);
      --text-strong: #e7f0ff;
      --text-subtle: #c2d3f1;
    }
    * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    body {
      background:
        radial-gradient(circle at 12% 18%, rgba(0, 200, 240, 0.18), transparent 28%),
        radial-gradient(circle at 85% 12%, rgba(255, 184, 28, 0.16), transparent 28%),
        radial-gradient(circle at 48% 78%, rgba(0, 39, 118, 0.18), transparent 24%),
        linear-gradient(160deg, #07122a, #0d2150);
      color: var(--text-strong);
      min-height: 100vh;
    }
    .glass {
      background: var(--card-dark);
      border: 1px solid rgba(0, 200, 240, 0.18);
      box-shadow: 0 24px 65px rgba(3, 18, 52, 0.48);
      backdrop-filter: blur(18px);
    }
    .hero {
      position: relative;
      overflow: hidden;
    }
    .hero::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 200, 240, 0.2), rgba(255, 184, 28, 0.18));
      opacity: 0.7;
      pointer-events: none;
    }
    .hero-badge {
      background: rgba(0, 200, 240, 0.16);
      border: 1px solid rgba(0, 200, 240, 0.42);
      color: #e6fbff;
    }
    .metric-card {
      border-radius: 18px;
      position: relative;
      overflow: hidden;
    }
    .metric-card .icon-wrap {
      width: 46px; height: 46px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(0,39,118,0.3), rgba(0,200,240,0.34));
      color: #e9f5ff;
    }
    .gradient-border {
      position: relative;
    }
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(120deg, rgba(0,200,240,0.32), rgba(255,184,28,0.3));
      z-index: -1;
    }
    .table-dark-glass {
      background: rgba(8, 19, 39, 0.72);
      border: 1px solid rgba(0, 92, 169, 0.28);
    }
    .aggregated-wrapper { overflow-x: auto; }
    .aggregated-table { min-width: 520px; }
    .aggregated-table td.text-end, .aggregated-table th.text-end { white-space: nowrap; }
    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      color: var(--text-strong);
      border: 1px solid rgba(0,200,240,0.22);
      background: rgba(0,200,240,0.08);
    }
    .pill-green { border-color: rgba(0, 200, 240, 0.55); color: #e6f8ff; background: rgba(0, 92, 169, 0.18); }
    .pill-amber { border-color: rgba(255, 184, 28, 0.62); color: #fff7dd; background: rgba(255, 184, 28, 0.16); }
    .pill-red { border-color: rgba(0, 92, 169, 0.5); color: #e8f1ff; background: rgba(0, 92, 169, 0.12); }
    .progress { height: 8px; }
    .text-success { color: var(--brand-amber) !important; }
    .search-input {
      background: rgba(0, 92, 169, 0.12);
      border: 1px solid rgba(0, 200, 240, 0.2);
      color: #e5ecf7;
    }
    .search-input:focus { box-shadow: 0 0 0 0.2rem rgba(0,200,240,0.26); }
    .small-label { color: var(--text-subtle); font-size: 0.9rem; }
    .brand-logo { max-height: 72px; }
    .footer {
      color: var(--text-subtle);
      border-top: 1px solid rgba(0, 200, 240, 0.12);
    }
    .btn-outline-info {
      color: #e7f8ff;
      border-color: rgba(0, 200, 240, 0.72);
      background: rgba(0, 200, 240, 0.12);
    }
    .btn-outline-info:hover, .btn-outline-info:focus {
      color: #031028;
      background-color: var(--brand-highlight);
      border-color: var(--brand-highlight);
      box-shadow: 0 0 0 0.2rem rgba(0,200,240,0.36);
    }
    .btn-outline-light {
      color: #fdf7ff;
      border-color: rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.08);
    }
    .btn-outline-light:hover, .btn-outline-light:focus {
      color: #041024;
      background-color: var(--brand-amber);
      border-color: var(--brand-amber);
      box-shadow: 0 0 0 0.2rem rgba(255,184,28,0.36);
    }
    .text-info { color: var(--brand-highlight) !important; }
    .border-info { border-color: rgba(0, 200, 240, 0.55) !important; }
    .badge.text-bg-info {
      background-color: rgba(0, 200, 240, 0.2) !important;
      color: var(--brand-highlight) !important;
      border: 1px solid rgba(0, 200, 240, 0.42) !important;
    }
    .bg-info { background-color: var(--brand-highlight) !important; }
    .bg-success { background-color: var(--brand-amber) !important; }

    /* Login overlay */
    .login-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at 12% 18%, rgba(0, 200, 240, 0.18), transparent 28%),
        radial-gradient(circle at 85% 12%, rgba(255, 184, 28, 0.16), transparent 28%),
        linear-gradient(160deg, rgba(7, 18, 42, 0.95), rgba(13, 33, 80, 0.96));
      z-index: 2000;
    }
    .login-card {
      width: min(420px, 90vw);
      background: rgba(0, 44, 102, 0.9);
      border: 1px solid rgba(0, 200, 240, 0.3);
      box-shadow: 0 24px 65px rgba(3, 18, 52, 0.48);
      backdrop-filter: blur(12px);
    }
    .login-logo { max-height: 72px; }
  </style>
</head>
<body>
  <div id="loginScreen" class="login-overlay">
    <div class="login-card rounded-4 p-4">
      <div class="text-center mb-3">
        <img src="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png" alt="Logotipo CNH Recife" class="login-logo mb-3">
        <h4 class="fw-bold mb-1">Acesso restrito</h4>
        <p class="text-white-50 mb-0">Informe usu√°rio e senha para entrar no painel</p>
      </div>
      <form id="loginForm" class="d-grid gap-3">
        <div>
          <label class="form-label text-white-50">Usu√°rio</label>
          <input type="text" id="usuario" class="form-control search-input" required autocomplete="username">
        </div>
        <div>
          <label class="form-label text-white-50">Senha</label>
          <input type="password" id="senha" class="form-control search-input" required autocomplete="current-password">
        </div>
        <div class="d-grid gap-2">
          <button type="submit" id="loginButton" class="btn btn-outline-info">Entrar</button>
          <div id="loginStatus" class="text-danger small"></div>
        </div>
      </form>
    </div>
  </div>

  <div id="dashboardApp" class="container py-4 d-none">
    <header class="hero glass rounded-4 p-4 p-md-5 mb-4 gradient-border">
      <div class="d-flex justify-content-between flex-column flex-md-row gap-3 align-items-start align-items-md-center">
        <div>
          <img src="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png" alt="Logotipo CNH Recife" class="brand-logo mb-3">
          <span class="hero-badge badge rounded-pill px-3 py-2 mb-3 fw-semibold">
            <i class="bi bi-speedometer2 me-1"></i> Painel Din√¢mico
          </span>
          <h1 class="fw-bold display-5 mb-2">CNH Recife</h1>
          <div id="saudacao" class="text-info fw-semibold mb-2"></div>
          <p class="fs-5 text-white-50 mb-3">Monitoramento em tempo real das inscri√ß√µes, perfis socioecon√¥micos e etapas de atendimento.</p>
          <div class="d-flex flex-wrap gap-2">
            <span class="chip"><i class="bi bi-broadcast-pin me-1"></i> Dados via webhook</span>
            <span class="chip pill-green"><i class="bi bi-check-circle me-1"></i> Atualiza√ß√µes autom√°ticas a cada 3min</span>
            <span class="chip pill-amber"><i class="bi bi-clock-history me-1"></i> Refresh manual</span>
            <span class="chip"><i class="bi bi-play-circle me-1"></i> In√≠cio do monitoramento: 06/12/2025 √†s 16:23</span>
          </div>
        </div>
        <div class="text-end">
          <button id="refreshBtn" class="btn btn-outline-info mb-2" disabled>
            <i class="bi bi-arrow-repeat me-1"></i> Atualizar dados
          </button>
          <div class="small-label">√öltima atualiza√ß√£o:<br><span id="lastSync">--</span></div>
        </div>
      </div>
    </header>

    <section class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="glass metric-card p-3 rounded-4 h-100 gradient-border">
          <div class="d-flex align-items-start gap-3">
            <div class="icon-wrap"><i class="bi bi-graph-up fs-5"></i></div>
            <div>
              <p class="small-label mb-1">Acessos ao formul√°rio</p>
              <h3 class="fw-bold mb-1" id="totalGeral">--</h3>
              <div class="text-info small">Total geral</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="glass metric-card p-3 rounded-4 h-100 gradient-border">
          <div class="d-flex align-items-start gap-3">
            <div class="icon-wrap"><i class="bi bi-calendar-day fs-5"></i></div>
            <div>
              <p class="small-label mb-1">Acessos de hoje</p>
              <h3 class="fw-bold mb-1" id="totalHoje">--</h3>
              <div class="text-success small">√öltimas 24h</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="glass metric-card p-3 rounded-4 h-100 gradient-border">
          <div class="d-flex align-items-start gap-3">
            <div class="icon-wrap"><i class="bi bi-clock-history fs-5"></i></div>
            <div>
              <p class="small-label mb-1">Acessos nesta hora</p>
              <h3 class="fw-bold mb-1" id="totalHora">--</h3>
              <div class="text-warning small">Janela de 60 minutos</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="glass metric-card p-3 rounded-4 h-100 gradient-border">
          <div class="d-flex align-items-start gap-3">
            <div class="icon-wrap"><i class="bi bi-people fs-5"></i></div>
            <div>
              <p class="small-label mb-1">Inscri√ß√µes recebidas</p>
              <h3 class="fw-bold mb-1" id="totalInscricoes">--</h3>
              <div class="text-success small" id="novasInscricoes">--</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="glass metric-card p-3 rounded-4 h-100 gradient-border">
          <div class="d-flex align-items-start gap-3">
            <div class="icon-wrap"><i class="bi bi-cash-stack fs-5"></i></div>
            <div>
              <p class="small-label mb-1">Renda per capita m√©dia</p>
              <h3 class="fw-bold mb-1" id="rendaMedia">--</h3>
              <div class="text-info small" id="pcdPercent">--</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="glass p-3 p-md-4 rounded-4 gradient-border h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Distribui√ß√£o de perfis</h5>
            <div class="chip">Fonte: Portal CNH Recife</div>
          </div>
          <div class="row g-3">
            <div class="col-md-6"><canvas id="chartGenero"></canvas></div>
            <div class="col-md-6"><canvas id="chartCategoria"></canvas></div>
            <div class="col-md-6"><canvas id="chartRenda"></canvas></div>
            <div class="col-md-6"><canvas id="chartContato"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="glass p-3 p-md-4 rounded-4 gradient-border h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Indicadores r√°pidos</h5>
            <span class="badge text-bg-info bg-opacity-25 border border-info text-info">Live</span>
          </div>
          <ul class="list-unstyled mb-3" id="indicadoresLista"></ul>
          <div>
            <p class="small-label mb-1">Ades√£o a canais preferenciais</p>
            <div class="progress bg-dark">
              <div id="progressWhatsapp" class="progress-bar bg-info" role="progressbar" style="width: 0%;"></div>
            </div>
            <p class="small-label mt-3 mb-1">Mulheres chefes de fam√≠lia</p>
            <div class="progress bg-dark">
              <div id="progressMulherChefe" class="progress-bar bg-success" role="progressbar" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="glass p-3 p-md-4 rounded-4 gradient-border mb-4">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
        <div>
          <h5 class="mb-0">Vis√£o agregada das inscri√ß√µes</h5>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <div class="spinner-border spinner-border-sm text-info d-none" role="status" id="loadingSpinner"></div>
        </div>
      </div>
      <div class="table-responsive rounded-3 aggregated-wrapper">
        <table class="table table-dark table-hover align-middle mb-0 table-dark-glass aggregated-table">
          <thead>
            <tr class="text-white-50">
              <th>Grupo</th>
              <th>Indicador</th>
              <th class="text-end">Quantidade</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <footer class="footer text-center py-3">
      <div class="small">Painel CNH Recife ¬∑ Dados recebidos via webhook oficial ¬∑ Exporta√ß√µes em CSV</div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const endpoint = 'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/4d5f64e7-0198-4dce-a44d-57e2acad6048-dashboardCNHRecife';
    const authEndpoint = 'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/acesso-dashboard';
    const sampleData = [
      {"cpf":"09100800465","nome_completo":"MARIA JESSYKA LEONEL DA SILVA","nome_social":null,"data_nascimento":"1991-01-09","idade":33,"nis_pis":"12345678901","data_atualizacao":"2025-02-10","tempo_desde_atualizacao":"10 dias","genero":"Feminino","telefone_whatsapp":"(81) 98888-0001","email":"maria.jessyka@example.com","canal_contato_preferencial":"WhatsApp","cep":"51020000","logradouro":"Rua das Flores","numero":"120","complemento":"Apto 302","bairro":"Boa Viagem","cidade":"Recife","uf":"PE","endereco_diferente_cadunico":"N√£o","situacao_trabalho":"Trabalho informal","mulher_chefe_familia":"Sim","acolhimento_institucional":"N√£o","dependente_tratamento":"N√£o","renda_per_capita":650.00,"raca_cor":"Parda","pessoa_preta_parda":"Sim","pessoa_indigena":"N√£o","pessoa_trans":"N√£o","egresso_socioeducativo":"N√£o","pessoa_quilombola":"N√£o","pessoa_situacao_rua":"N√£o","pessoa_pcd":"N√£o","mae_pai_atipico":"N√£o","vitima_violencia_domestica":"N√£o","necessidades_especificas":null,"categoria_desejada":"B","validade_cnh":"2028-05-15","termo_lgpd":"Aceito","declaracao_veracidade":"Confirmado","autorizacao_imagem":"Autorizo","renda_familiar":2600.00,"analise_socio_ocupacional":"Baixa renda, chefe de fam√≠lia","composicao_familiar":4,"participacao_programas_sociais":"Bolsa Fam√≠lia","recinscricao":"N√£o","possui_recurso_inscricao":"N√£o","trabalhador_app":"N√£o"},
      {"cpf":"22233344455","nome_completo":"JO√ÉO CARLOS DE ALMEIDA","nome_social":null,"data_nascimento":"1987-07-21","idade":37,"nis_pis":"98765432100","data_atualizacao":"2025-02-12","tempo_desde_atualizacao":"8 dias","genero":"Masculino","telefone_whatsapp":"(81) 98989-0002","email":"joao.almeida@example.com","canal_contato_preferencial":"E-mail","cep":"52011000","logradouro":"Avenida Norte","numero":"1500","complemento":null,"bairro":"Casa Amarela","cidade":"Recife","uf":"PE","endereco_diferente_cadunico":"Sim","situacao_trabalho":"Trabalhador com carteira assinada","mulher_chefe_familia":"N√£o","acolhimento_institucional":"N√£o","dependente_tratamento":"Sim","renda_per_capita":1200.50,"raca_cor":"Branca","pessoa_preta_parda":"N√£o","pessoa_indigena":"N√£o","pessoa_trans":"N√£o","egresso_socioeducativo":"N√£o","pessoa_quilombola":"N√£o","pessoa_situacao_rua":"N√£o","pessoa_pcd":"Sim","mae_pai_atipico":"Sim","vitima_violencia_domestica":"N√£o","necessidades_especificas":"Dependente em tratamento","categoria_desejada":"D","validade_cnh":"2027-09-30","termo_lgpd":"Aceito","declaracao_veracidade":"Confirmado","autorizacao_imagem":"N√£o autorizo","renda_familiar":4802.00,"analise_socio_ocupacional":"Renda est√°vel, dependente PCD","composicao_familiar":4,"participacao_programas_sociais":"BPC","recinscricao":"N√£o","possui_recurso_inscricao":"N√£o","trabalhador_app":"N√£o"},
      {"cpf":"33344455566","nome_completo":"ANA PAULA DOS SANTOS","nome_social":"ANA SANTOS","data_nascimento":"2000-03-05","idade":24,"nis_pis":"11223344556","data_atualizacao":"2025-01-28","tempo_desde_atualizacao":"23 dias","genero":"Mulher trans","telefone_whatsapp":"(81) 98777-1234","email":"ana.santos@example.com","canal_contato_preferencial":"WhatsApp","cep":"50030000","logradouro":"Rua da Aurora","numero":"45","complemento":"Casa","bairro":"Boa Vista","cidade":"Recife","uf":"PE","endereco_diferente_cadunico":"N√£o","situacao_trabalho":"Trabalhador de app","mulher_chefe_familia":"N√£o","acolhimento_institucional":"N√£o","dependente_tratamento":"N√£o","renda_per_capita":950.75,"raca_cor":"Preta","pessoa_preta_parda":"Sim","pessoa_indigena":"N√£o","pessoa_trans":"Sim","egresso_socioeducativo":"N√£o","pessoa_quilombola":"N√£o","pessoa_situacao_rua":"N√£o","pessoa_pcd":"N√£o","mae_pai_atipico":"N√£o","vitima_violencia_domestica":"Sim","necessidades_especificas":"Acompanhamento psicol√≥gico","categoria_desejada":"AB","validade_cnh":"2026-11-10","termo_lgpd":"Aceito","declaracao_veracidade":"Confirmado","autorizacao_imagem":"Autorizo","renda_familiar":1901.50,"analise_socio_ocupacional":"Trabalho por aplicativo, vulnerabilidade social","composicao_familiar":2,"participacao_programas_sociais":"Bolsa Fam√≠lia","recinscricao":"Sim","possui_recurso_inscricao":"N√£o","trabalhador_app":"Sim"},
      {"cpf":"44455566677","nome_completo":"JOS√â ROBERTO PEREIRA","nome_social":null,"data_nascimento":"1975-11-30","idade":49,"nis_pis":null,"data_atualizacao":"2024-12-15","tempo_desde_atualizacao":"67 dias","genero":"Masculino","telefone_whatsapp":"(81) 98555-9876","email":"jose.roberto@example.com","canal_contato_preferencial":"Telefone","cep":"52061000","logradouro":"Rua Principal","numero":"900","complemento":"Fundos","bairro":"Parnamirim","cidade":"Recife","uf":"PE","endereco_diferente_cadunico":"Sim","situacao_trabalho":"Desempregado","mulher_chefe_familia":"N√£o","acolhimento_institucional":"N√£o","dependente_tratamento":"N√£o","renda_per_capita":300.00,"raca_cor":"Parda","pessoa_preta_parda":"Sim","pessoa_indigena":"N√£o","pessoa_trans":"N√£o","egresso_socioeducativo":"Sim","pessoa_quilombola":"N√£o","pessoa_situacao_rua":"Sim","pessoa_pcd":"N√£o","mae_pai_atipico":"N√£o","vitima_violencia_domestica":"N√£o","necessidades_especificas":"Situa√ß√£o de rua","categoria_desejada":"B","validade_cnh":"2023-08-01","termo_lgpd":"Aceito","declaracao_veracidade":"Confirmado","autorizacao_imagem":"N√£o autorizo","renda_familiar":600.00,"analise_socio_ocupacional":"Desempregado, situa√ß√£o de rua","composicao_familiar":2,"participacao_programas_sociais":"Nenhum","recinscricao":"N√£o","possui_recurso_inscricao":"Sim","trabalhador_app":"N√£o"},
      {"cpf":"55566677788","nome_completo":"LUCIANA FERREIRA DA COSTA","nome_social":null,"data_nascimento":"1995-02-18","idade":30,"nis_pis":"55667788990","data_atualizacao":"2025-02-15","tempo_desde_atualizacao":"5 dias","genero":"Feminino","telefone_whatsapp":"(81) 98444-2222","email":"luciana.costa@example.com","canal_contato_preferencial":"WhatsApp","cep":"50720200","logradouro":"Rua da Paz","numero":"35","complemento":"Bloco B, apto 101","bairro":"Cordeiro","cidade":"Recife","uf":"PE","endereco_diferente_cadunico":"N√£o","situacao_trabalho":"Aut√¥nomo","mulher_chefe_familia":"Sim","acolhimento_institucional":"N√£o","dependente_tratamento":"Sim","renda_per_capita":730.25,"raca_cor":"Parda","pessoa_preta_parda":"Sim","pessoa_indigena":"N√£o","pessoa_trans":"N√£o","egresso_socioeducativo":"N√£o","pessoa_quilombola":"N√£o","pessoa_situacao_rua":"N√£o","pessoa_pcd":"Sim","mae_pai_atipico":"Sim","vitima_violencia_domestica":"Sim","necessidades_especificas":"Filho TEA","categoria_desejada":"B","validade_cnh":"2029-01-20","termo_lgpd":"Aceito","declaracao_veracidade":"Confirmado","autorizacao_imagem":"Autorizo","renda_familiar":2921.00,"analise_socio_ocupacional":"Aut√¥noma, m√£e at√≠pica, PCD no domic√≠lio","composicao_familiar":4,"participacao_programas_sociais":"Bolsa Fam√≠lia; BPC","recinscricao":"N√£o","possui_recurso_inscricao":"N√£o","trabalhador_app":"N√£o"},
      {"total_geral":"2566","total_hoje":"2566","total_hora_atual":"118"}
    ];

    let charts = {};
    const normalizeTotals = (value, fallback = 0) => {
      const num = Number(value);
      return Number.isFinite(num) ? num : fallback;
    };

    const sentenceCase = (value) => {
      const text = String(value ?? '').trim();
      if (!text) return 'N√£o informado';
      return text
        .toLocaleLowerCase('pt-BR')
        .split(/(\s+|;|,)/)
        .map(part => /^(\s+|;|,)$/.test(part)
          ? part
          : part.charAt(0).toLocaleUpperCase('pt-BR') + part.slice(1))
        .join('');
    };

    const normalizeName = (name) => {
      const safe = String(name ?? '').trim();
      if (!safe) return '';
      return safe
        .toLocaleLowerCase('pt-BR')
        .split(/\s+/)
        .filter(Boolean)
        .map(part => part.charAt(0).toLocaleUpperCase('pt-BR') + part.slice(1))
        .join(' ');
    };

    const greetingByHour = () => {
      const hour = Number(new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Recife', hour: '2-digit', hour12: false }).format(new Date()));
      if (hour < 12) return 'Bom dia';
      if (hour < 18) return 'Boa tarde';
      return 'Boa noite';
    };

    const isTotalsObject = (item = {}) => {
      if (typeof item !== 'object' || item === null) return false;
      const hasTotalKey = ['total_geral', 'total_hoje', 'total_hora_atual'].some(key => key in item);
      const hasPersonKey = ['cpf', 'nome_completo', 'idade', 'data_nascimento'].some(key => key in item);
      return hasTotalKey && !hasPersonKey;
    };

    const normalizePayload = (payload = []) => {
      const data = Array.isArray(payload) ? [...payload] : [];
      const totalsIndex = data.findIndex(isTotalsObject);
      const records = data.filter((item, idx) => {
        if (idx === totalsIndex) return false;
        if (!item || typeof item !== 'object') return false;
        return ['cpf', 'nome_completo', 'idade', 'data_nascimento'].some(key => key in item);
      });
      const totalsSource = totalsIndex >= 0 ? data[totalsIndex] : {};

      const totals = {
        total_geral: normalizeTotals(totalsSource.total_geral, records.length),
        total_hoje: normalizeTotals(totalsSource.total_hoje, 0),
        total_hora_atual: normalizeTotals(totalsSource.total_hora_atual, 0)
      };

      return { records, totals };
    };

    const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

    const normalizeValue = (value, type = 'generic') => {
      if (!value) return 'N√£o informado';
      const raw = String(value).trim();
      if (type === 'categoria') {
        const upper = raw.toUpperCase();
        const maps = {
          'A_PRIMEIRA': 'Primeira habilita√ß√£o - A',
          'A PRIMEIRA': 'Primeira habilita√ß√£o - A',
          'A': 'A',
          'AB': 'AB',
          'B': 'B',
          'C': 'C',
          'D': 'D',
          'E': 'E'
        };
        return maps[upper] || upper;
      }
      return sentenceCase(raw.replace(/_/g, ' '));
    };

    const groupCount = (arr, key, type = 'generic') => arr.reduce((acc, item) => {
      const v = normalizeValue(item[key], type);
      acc[v] = (acc[v] || 0) + 1;
      return acc;
    }, {});

    const rendaFaixas = (renda) => {
      if (renda === null || renda === undefined) return 'N√£o informado';
      if (renda <= 500) return 'At√© R$500';
      if (renda <= 900) return 'R$501 - R$900';
      if (renda <= 1500) return 'R$901 - R$1500';
      return 'Acima de R$1500';
    };

    const renderChart = (id, type, labels, data, colors) => {
      if (charts[id]) charts[id].destroy();
      const ctx = document.getElementById(id);
      charts[id] = new Chart(ctx, {
        type,
        data: {
          labels,
          datasets: [{
            label: 'Quantidade',
            data,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('0.85', '1')),
            borderWidth: 1,
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#d9e2ff' } } },
          scales: type === 'pie' ? {} : { x: { ticks: { color: '#c7d2f0' } }, y: { ticks: { color: '#c7d2f0' }, beginAtZero: true } }
        }
      });
    };

    const updateTotals = (totals, fallbackCount = 0) => {
      const totalGeral = normalizeTotals(totals.total_geral, fallbackCount);
      const totalHoje = normalizeTotals(totals.total_hoje, 0);
      const totalHora = normalizeTotals(totals.total_hora_atual, 0);

      document.getElementById('totalGeral').innerText = totalGeral.toLocaleString('pt-BR');
      document.getElementById('totalHoje').innerText = totalHoje.toLocaleString('pt-BR');
      document.getElementById('totalHora').innerText = totalHora.toLocaleString('pt-BR');
    };

    const updateIndicators = (data) => {
      const total = data.length;
      const rendaValores = data.map(item => Number(item.renda_per_capita)).filter(Number.isFinite);
      const idadeValores = data.map(item => Number(item.idade)).filter(Number.isFinite);
      const rendaMedia = rendaValores.length ? rendaValores.reduce((sum, v) => sum + v, 0) / rendaValores.length : 0;
      const mediaIdade = idadeValores.length ? idadeValores.reduce((sum, v) => sum + v, 0) / idadeValores.length : 0;
      const pcd = data.filter(i => (i.pessoa_pcd || '').toLowerCase() === 'sim').length;
      const atualizados15 = data.filter(i => {
        const diff = (Date.now() - new Date(i.data_atualizacao)) / (1000 * 60 * 60 * 24);
        return Number.isFinite(diff) && diff <= 15;
      }).length;
      const whatsapp = data.filter(i => (i.canal_contato_preferencial || '').toLowerCase().includes('whatsapp')).length;
      const mulherChefe = data.filter(i => (i.mulher_chefe_familia || '').toLowerCase() === 'sim').length;

      document.getElementById('totalInscricoes').innerText = total;
      document.getElementById('novasInscricoes').innerText = total ? `${atualizados15} atualiza√ß√µes em 15 dias` : 'Sem inscri√ß√µes no per√≠odo';
      document.getElementById('rendaMedia').innerText = formatCurrency(rendaMedia);
      document.getElementById('pcdPercent').innerText = rendaValores.length
        ? 'M√©dia das rendas informadas'
        : 'Sem dados de renda declarada';

      const whatsappPct = total ? Math.round((whatsapp / total) * 100) : 0;
      const mulherChefePct = total ? Math.round((mulherChefe / total) * 100) : 0;

      document.getElementById('progressWhatsapp').style.width = `${whatsappPct}%`;
      document.getElementById('progressMulherChefe').style.width = `${mulherChefePct}%`;
      const indicadores = [
        { label: 'Preferem WhatsApp', value: `${whatsappPct}%` },
        { label: 'Mulheres chefes de fam√≠lia', value: `${mulherChefePct}%` },
        { label: 'PCD declarados', value: `${pcd}` },
        { label: 'Renda familiar m√©dia', value: formatCurrency(data.reduce((s, i) => s + (Number(i.renda_familiar) || 0), 0) / Math.max(total,1)) },
        { label: 'Idade m√©dia', value: `${mediaIdade.toFixed(1)} anos` }
      ];
      const list = document.getElementById('indicadoresLista');
      list.innerHTML = '';
      indicadores.forEach(item => {
        const li = document.createElement('li');
        li.className = 'd-flex justify-content-between border-bottom border-secondary-subtle py-2';
        li.innerHTML = `<span class="text-white-50">${item.label}</span><span class="fw-semibold">${item.value}</span>`;
        list.appendChild(li);
      });
    };

    const renderCharts = (data) => {
      const generoCounts = groupCount(data, 'genero');
      const categoriaCounts = groupCount(data, 'categoria_desejada', 'categoria');
      const rendaCounts = data.reduce((acc, item) => {
        const faixa = normalizeValue(rendaFaixas(item.renda_per_capita));
        acc[faixa] = (acc[faixa] || 0) + 1;
        return acc;
      }, {});
      const contatoCounts = groupCount(data, 'canal_contato_preferencial');

      const palette = [
        'rgba(0,39,118,0.9)',   // azul prim√°rio
        'rgba(0,92,169,0.9)',   // azul secund√°rio
        'rgba(0,200,240,0.9)',  // ciano destaque
        'rgba(255,184,28,0.88)',// amarelo institucional
        'rgba(210,225,248,0.92)'
      ];

      renderChart('chartGenero', 'pie', Object.keys(generoCounts), Object.values(generoCounts), palette);
      renderChart('chartCategoria', 'doughnut', Object.keys(categoriaCounts), Object.values(categoriaCounts), palette);
      renderChart('chartRenda', 'bar', Object.keys(rendaCounts), Object.values(rendaCounts), palette);
      renderChart('chartContato', 'bar', Object.keys(contatoCounts), Object.values(contatoCounts), palette);
    };

    const buildAggregatedGroups = (data) => {
      const groups = [
        { label: 'Categoria desejada', counts: groupCount(data, 'categoria_desejada', 'categoria') },
        { label: 'G√™nero', counts: groupCount(data, 'genero') },
        { label: 'Canal preferencial', counts: groupCount(data, 'canal_contato_preferencial') },
        { label: 'Faixa de renda per capita', counts: groupCount(data.map(item => ({ faixa: rendaFaixas(item.renda_per_capita) })), 'faixa') },
        { label: 'Trabalho / renda', counts: groupCount(data, 'situacao_trabalho') },
        { label: 'Programa social', counts: groupCount(data, 'participacao_programas_sociais') },
      ];

      return groups.map(group => ({
        grupo: group.label,
        indicadores: Object.entries(group.counts).map(([indicador, qtd]) => ({ indicador, qtd }))
      })).filter(group => group.indicadores.length);
    };

    const renderTable = (data) => {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      const groups = buildAggregatedGroups(data);
      groups.forEach(group => {
        group.indicadores.forEach((row, idx) => {
          const tr = document.createElement('tr');
          if (idx === 0) {
            const tdGroup = document.createElement('td');
            tdGroup.className = 'text-white-50 align-middle';
            tdGroup.rowSpan = group.indicadores.length;
            tdGroup.textContent = group.grupo;
            tr.appendChild(tdGroup);
          }
          const tdIndicador = document.createElement('td');
          tdIndicador.className = 'fw-semibold';
          tdIndicador.textContent = row.indicador;
          const tdQtd = document.createElement('td');
          tdQtd.className = 'text-end';
          tdQtd.textContent = row.qtd;
          tr.appendChild(tdIndicador);
          tr.appendChild(tdQtd);
          tbody.appendChild(tr);
        });
      });
    };

    const setLoading = (loading) => {
      document.getElementById('loadingSpinner').classList.toggle('d-none', !loading);
      document.getElementById('refreshBtn').disabled = loading;
    };

    let currentData = [];
    let refreshTimer = null;

    const setGreeting = (username) => {
      const target = document.getElementById('saudacao');
      const formatted = normalizeName(username);
      const lowered = formatted.toLocaleLowerCase('pt-BR');
      if (lowered === 'oto') {
        target.textContent = 'Oto, voc√™ √© um fofo! üòç';
        return;
      }
      if (!formatted) {
        target.textContent = '';
        return;
      }
      target.textContent = `${greetingByHour()}, ${formatted}.`;
    };

    const startAutoRefresh = () => {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(loadData, 180000);
    };

    const hydrate = (data) => {
      const { records, totals } = normalizePayload(data);
      currentData = records;
      updateTotals(totals, records.length);
      updateIndicators(records);
      renderCharts(records);
      renderTable(records);
      document.getElementById('lastSync').innerText = new Date().toLocaleString('pt-BR');
    };

    const loadData = async () => {
      setLoading(true);
      try {
        const response = await fetch(endpoint, { method: 'POST' });
        if (!response.ok) throw new Error('Erro ao buscar webhook');
        const payload = await response.json();
        hydrate(payload);
      } catch (err) {
        console.warn('Usando dados de fallback:', err.message);
        hydrate(sampleData);
      } finally {
        setLoading(false);
      }
    };

    document.getElementById('refreshBtn').addEventListener('click', loadData);

    const senhaInput = document.getElementById('senha');
    senhaInput.addEventListener('paste', (event) => {
      event.preventDefault();
      const plain = (event.clipboardData || window.clipboardData)?.getData('text') || '';
      senhaInput.value = plain.trim();
    });

    const setLoginLoading = (loading) => {
      const btn = document.getElementById('loginButton');
      btn.disabled = loading;
      btn.innerHTML = loading
        ? '<span class="spinner-border spinner-border-sm me-1"></span>Validando...'
        : 'Entrar';
    };

    const authenticate = async (usuario, senha) => {
      const response = await fetch(authEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usuario, senha })
      });
      const text = (await response.text()).trim();
      if (response.ok && text.toLowerCase() === 'login bem sucedido') return true;
      throw new Error(text || 'Credenciais inv√°lidas');
    };

    document.getElementById('loginForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const status = document.getElementById('loginStatus');
      status.textContent = '';
      setLoginLoading(true);
      try {
        const usuario = document.getElementById('usuario').value.trim();
        const senha = document.getElementById('senha').value.trim();
        await authenticate(usuario, senha);
        setGreeting(usuario);
        document.getElementById('loginScreen').classList.add('d-none');
        document.getElementById('dashboardApp').classList.remove('d-none');
        document.getElementById('refreshBtn').disabled = false;
        await loadData();
        startAutoRefresh();
      } catch (err) {
        status.textContent = err.message || 'N√£o foi poss√≠vel autenticar';
      } finally {
        setLoginLoading(false);
      }
    });
  </script>
</body>
</html>
