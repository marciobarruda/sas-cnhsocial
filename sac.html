<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Avaliação do Serviço • CNH Social</title>

    <link
      rel="icon"
      href="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-highlight: #00a3ff;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        color: var(--text-strong);
        min-height: 100vh;
      }

      .modal-dialog {
        max-width: 760px;
      }

      .modal-content {
        border: none;
        border-radius: 1.25rem;
        box-shadow: 0 24px 60px rgba(0, 35, 79, 0.2);
      }

      .modal-title {
        font-weight: 800;
        color: var(--text-strong);
      }

      .subtitle {
        color: var(--text-muted);
      }

      .stars {
        display: flex;
        gap: 1.25rem;
        font-size: 4.75rem;
        justify-content: center;
      }

      .star {
        cursor: pointer;
        color: #e8e6df;
        transition: color 0.15s ease-in-out, transform 0.15s ease-in-out;
      }

      .star.filled {
        color: #ffbe3c;
      }

      .star:hover {
        transform: translateY(-3px);
        color: #ffc94a;
      }
    </style>
  </head>

  <body>
    <div
      class="modal fade"
      id="avaliacaoModal"
      tabindex="-1"
      aria-labelledby="avaliacaoModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-body p-4 p-md-5">
            <div class="d-flex flex-column gap-4">
              <div>
                <h1 class="modal-title h4 mb-1" id="avaliacaoModalLabel">
                  Avalie o serviço
                </h1>
                <p class="mb-0 subtitle">
                  Como foi sua experiência com o envio da inscrição?
                </p>
              </div>

              <form
                id="formAvaliacao"
                class="d-flex flex-column gap-4"
                action="https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/avaliacao-cnh"
                method="POST"
              >
                <div class="text-center">
                  <div class="stars" role="radiogroup" aria-label="Nota do serviço">
                    <button
                      type="button"
                      class="btn btn-link p-0 star"
                      data-value="1"
                      aria-label="1 estrela"
                    >
                      ★
                    </button>
                    <button
                      type="button"
                      class="btn btn-link p-0 star"
                      data-value="2"
                      aria-label="2 estrelas"
                    >
                      ★
                    </button>
                    <button
                      type="button"
                      class="btn btn-link p-0 star"
                      data-value="3"
                      aria-label="3 estrelas"
                    >
                      ★
                    </button>
                    <button
                      type="button"
                      class="btn btn-link p-0 star"
                      data-value="4"
                      aria-label="4 estrelas"
                    >
                      ★
                    </button>
                    <button
                      type="button"
                      class="btn btn-link p-0 star"
                      data-value="5"
                      aria-label="5 estrelas"
                    >
                      ★
                    </button>
                  </div>
                  <input type="hidden" name="nota" id="nota" required />
                  <div class="invalid-feedback d-block" id="notaFeedback"></div>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label for="email" class="form-label fw-semibold">E-mail</label>
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      name="email"
                      placeholder="seuemail@exemplo.com"
                      required
                    />
                    <div class="invalid-feedback">Informe um e-mail válido.</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label for="nome" class="form-label fw-semibold">Nome</label>
                    <input
                      type="text"
                      class="form-control"
                      id="nome"
                      name="nome"
                      placeholder="Digite seu nome"
                      required
                    />
                    <div class="invalid-feedback">Informe seu nome.</div>
                  </div>
                </div>

                <div>
                  <div class="d-flex align-items-center justify-content-between mb-1">
                    <label for="comentario" class="form-label fw-semibold mb-0"
                      >Comentário</label
                    >
                    <small class="text-danger">Obrigatório! Sua sugestão.</small>
                  </div>
                  <textarea
                    class="form-control"
                    id="comentario"
                    name="comentario"
                    rows="3"
                    placeholder="Comente rapidamente de acordo com a nota escolhida."
                    required
                  ></textarea>
                  <div class="invalid-feedback">Deixe seu comentário.</div>
                </div>

                <div class="d-flex flex-column flex-sm-row gap-2 mt-2">
                  <button
                    type="button"
                    id="cancelButton"
                    class="btn btn-outline-secondary flex-fill"
                    data-bs-dismiss="modal"
                  >
                    Pular
                  </button>
                  <button
                    type="submit"
                    id="submitButton"
                    class="btn btn-primary flex-fill"
                  >
                    Enviar avaliação
                  </button>
                </div>
                <div
                  id="submitFeedback"
                  class="text-center small mt-2 text-muted"
                ></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const modalElement = document.getElementById("avaliacaoModal");
        const modal = new bootstrap.Modal(modalElement, {
          backdrop: "static",
          keyboard: false,
        });
        modal.show();

        const stars = document.querySelectorAll(".star");
        const notaInput = document.getElementById("nota");
        const notaFeedback = document.getElementById("notaFeedback");
        const form = document.getElementById("formAvaliacao");
        const submitFeedback = document.getElementById("submitFeedback");
        const submitButton = document.getElementById("submitButton");
        const cancelButton = document.getElementById("cancelButton");
        const redirectUrl = "https://cnhrecife.recife.pe.gov.br";

        const atualizarEstrelas = (valor) => {
          stars.forEach((star) => {
            const starValue = Number(star.dataset.value);
            star.classList.toggle("filled", starValue <= valor);
          });
        };

        stars.forEach((star) => {
          star.addEventListener("click", () => {
            const valor = Number(star.dataset.value);
            notaInput.value = valor;
            notaFeedback.textContent = "";
            atualizarEstrelas(valor);
          });
        });

        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          if (!notaInput.value) {
            notaFeedback.textContent = "Selecione uma nota de 1 a 5 estrelas.";
            modalElement.scrollTop = 0;
          }

          if (!form.checkValidity() || !notaInput.value) {
            event.stopPropagation();
            form.classList.add("was-validated");
            return;
          }

          form.classList.add("was-validated");
          submitFeedback.textContent = "Enviando sua avaliação...";
          submitButton.disabled = true;
          cancelButton.disabled = true;

          try {
            const response = await fetch(form.action, {
              method: "POST",
              body: new FormData(form),
            });

            if (!response.ok) {
              throw new Error("Falha ao enviar a avaliação.");
            }

            let countdown = 5;
            submitFeedback.classList.remove("text-muted", "text-danger");
            submitFeedback.classList.add("text-success");
            submitFeedback.textContent = `Avaliação enviada com sucesso! Redirecionando em ${countdown}s...`;

            const countdownInterval = setInterval(() => {
              countdown -= 1;
              submitFeedback.textContent = `Avaliação enviada com sucesso! Redirecionando em ${countdown}s...`;

              if (countdown <= 0) {
                clearInterval(countdownInterval);
                window.location.href = redirectUrl;
              }
            }, 1000);
          } catch (error) {
            submitFeedback.classList.remove("text-success", "text-muted");
            submitFeedback.classList.add("text-danger");
            submitFeedback.textContent =
              "Não foi possível enviar sua avaliação. Tente novamente em instantes.";
            submitButton.disabled = false;
            cancelButton.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
