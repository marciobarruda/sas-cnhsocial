<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAS • CNH Social</title>

    <link
      rel="icon"
      href="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
        --shadow-strong: 0 14px 30px rgba(0, 35, 79, 0.15);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      .page-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }

      .card-programa {
        border: 1px solid rgba(0, 83, 164, 0.08);
        background: var(--surface-strong);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.18);
        border-radius: 1.25rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-strong);
        margin-bottom: 0;
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .institucional-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        background: rgba(0, 83, 164, 0.06);
        color: var(--brand-secondary);
      }

      .institucional-pill-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--brand-highlight);
      }

      .modal-backdrop-custom {
        background: radial-gradient(
          circle at top,
          rgba(0, 83, 164, 0.18),
          rgba(0, 0, 0, 0.55)
        );
      }

      .modal-dialog.modal-lg {
        max-width: 760px;
      }

      .modal.fade .modal-dialog {
        transform: translateY(12px) scale(0.98);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      }

      .modal.fade.show .modal-dialog {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      .modal-logo {
        max-width: 120px;
        height: auto;
        display: inline-block;
      }

      .form-control:focus {
        border-color: var(--brand-highlight);
        box-shadow: 0 0 0 0.2rem rgba(0, 163, 255, 0.25);
      }

      .logo {
        max-width: 200px;
        height: auto;
      }

      @media (min-width: 768px) {
        .page-wrapper {
          padding: 3rem 1.5rem;
        }
      }
    </style>
  </head>

  <body>
    <main class="page-wrapper">
      <div class="container" style="max-width: 720px">
        <div class="card card-programa border-0 p-4 p-md-5">
          <div class="text-center mb-4">
            <img
              src="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
              alt="CNH Social Recife"
              class="logo"
            />
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="section-title">Consultar inscrição</h1>
            <span class="institucional-pill">
              <span class="institucional-pill-dot"></span>
              Informe seu CPF para continuar
            </span>
          </div>

          <form id="consulta-form" novalidate>
            <div class="mb-3">
              <label for="cpf" class="form-label">CPF</label>
              <input
                type="text"
                inputmode="numeric"
                pattern="\d{11}"
                maxlength="11"
                class="form-control form-control-lg"
                id="cpf"
                name="cpf"
                placeholder="Digite apenas números"
                required
              />
              <div class="form-text">Digite exatamente 11 dígitos numéricos.</div>
              <div class="invalid-feedback" id="cpf-feedback">
                Informe um CPF válido com 11 dígitos numéricos.
              </div>
            </div>

            <div class="d-grid d-md-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg px-4">
                Consultar inscrição
              </button>
              <a
                class="btn btn-outline-secondary btn-lg px-4"
                href="https://cnhsocial.recife.pe.gov.br/"
              >
                Voltar para o site
              </a>
            </div>
          </form>
        </div>
      </div>
    </main>

    <div
      class="modal fade"
      id="avisoModal"
      tabindex="-1"
      aria-labelledby="avisoModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-4 card-programa">
          <div class="modal-body p-4 p-md-5">
            <div class="d-flex flex-column gap-3">
              <div class="text-center mb-2">
                <img
                  src="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
                  alt="CNH Social Recife"
                  class="modal-logo"
                />
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="section-title" id="avisoModalLabel">
                  Inscrição já encontrada
                </h2>
              </div>

              <span class="institucional-pill">
                <span class="institucional-pill-dot"></span>
                Aviso importante
              </span>

              <p class="mb-1 mt-2 fs-6 text-muted" id="mensagem-inscricao">
                <strong>
                  Consultando inscrição ativa para o CPF
                  <span id="cpf-mascarado"></span>
                  no programa CNH Social Recife...
                </strong>
              </p>

              <div class="d-flex justify-content-end gap-2 mt-2">
                <button class="btn btn-outline-secondary" id="fechar-modal">
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("consulta-form");
        const cpfInput = document.getElementById("cpf");
        const feedbackCpf = document.getElementById("cpf-feedback");
        const mensagemInscricao = document.getElementById("mensagem-inscricao");
        const cpfSpan = document.getElementById("cpf-mascarado");
        const modalElement = document.getElementById("avisoModal");
        const modal = new bootstrap.Modal(modalElement, {
          backdrop: "static",
          keyboard: false,
        });

        modalElement.addEventListener("shown.bs.modal", () => {
          modalElement.classList.add("show");
        });

        const sanitizeHtml = (texto) =>
          texto
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");

        const formatarMarkdownSimples = (texto) => {
          const seguro = sanitizeHtml(texto);
          return seguro
            .replace(/^\s*[-•]\s+/gm, "• ")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\n/g, "<br>");
        };

        const extrairMensagemSesuite = (payload) => {
          if (typeof payload === "string") {
            return payload.trim();
          }

          if (Array.isArray(payload) && payload.length > 0) {
            return (
              payload[0]?.mensagem ||
              payload[0]?.message ||
              payload[0]?.descricao ||
              "Inscrição ativa localizada para o CPF informado."
            );
          }

          return (
            payload?.mensagem ||
            payload?.message ||
            payload?.descricao ||
            "Inscrição ativa localizada para o CPF informado."
          );
        };

        const mascararCpf = (cpf) => {
          if (cpf.length === 11) {
            const primeiros3 = cpf.slice(0, 3);
            const ultimos2 = cpf.slice(-2);
            return `${primeiros3}.***.***-${ultimos2}`;
          }
          return "não identificado";
        };

        const atualizarCpfMascarado = (cpfNumeros) => {
          if (cpfSpan) {
            cpfSpan.textContent = mascararCpf(cpfNumeros);
          }
        };

        const definirMensagemInicial = (cpfNumeros) => {
          mensagemInscricao.innerHTML = `<strong>Consultando inscrição ativa para o CPF ${mascararCpf(
            cpfNumeros
          )} no programa CNH Social Recife...</strong>`;
        };

        const consultarInscricao = async (cpfNumeros) => {
          if (!cpfNumeros) {
            mensagemInscricao.textContent =
              "Não foi possível identificar o CPF para consulta.";
            return;
          }

          const enviarParaSesuite = async (dadosInscricao) => {
            const respostaSesuite = await fetch(
              "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/consultar-cnh-sesuite",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(dadosInscricao),
              }
            );

            if (!respostaSesuite.ok) {
              throw new Error(`Erro ao consultar SESuite: ${respostaSesuite.status}`);
            }

            const texto = await respostaSesuite.text();
            try {
              return JSON.parse(texto);
            } catch (_erroParsing) {
              return texto.trim();
            }
          };

          try {
            const resposta = await fetch(
              "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/consultar-inscricao-por-cpf",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ cpfNumeros }),
              }
            );

            if (!resposta.ok) {
              throw new Error(`Erro na consulta: ${resposta.status}`);
            }

            const payloadInscricao = await resposta.json();

            try {
              const retornoSesuite = await enviarParaSesuite(payloadInscricao);
              const mensagemPrincipal = extrairMensagemSesuite(retornoSesuite);

              const mensagemFormatada = formatarMarkdownSimples(mensagemPrincipal);

              mensagemInscricao.innerHTML = `<strong>${mensagemFormatada}</strong>`;
            } catch (erroSesuite) {
              mensagemInscricao.innerHTML =
                "<strong>Não foi possível recuperar a situação da inscrição no momento.</strong>";
            }
          } catch (erro) {
            mensagemInscricao.innerHTML =
              "<strong>Não foi possível recuperar sua inscrição no momento.</strong>";
          }
        };

        const normalizarCpf = (valor) => valor.replace(/\D/g, "").slice(0, 11);

        cpfInput.addEventListener("input", (event) => {
          const apenasNumeros = normalizarCpf(event.target.value);
          event.target.value = apenasNumeros;
          if (apenasNumeros.length === 11) {
            cpfInput.classList.remove("is-invalid");
          }
        });

        form.addEventListener("submit", (event) => {
          event.preventDefault();

          const cpfNormalizado = normalizarCpf(cpfInput.value);

          if (cpfNormalizado.length !== 11) {
            cpfInput.classList.add("is-invalid");
            if (feedbackCpf) {
              feedbackCpf.textContent =
                "Informe um CPF válido com 11 dígitos numéricos.";
            }
            cpfInput.focus();
            return;
          }

          cpfInput.classList.remove("is-invalid");
          atualizarCpfMascarado(cpfNormalizado);
          definirMensagemInicial(cpfNormalizado);
          modal.show();
          consultarInscricao(cpfNormalizado);
        });

        const fecharBtn = document.getElementById("fechar-modal");
        if (fecharBtn) {
          fecharBtn.addEventListener("click", () => {
            window.location.href = "https://cnhsocial.recife.pe.gov.br/";
          });
        }
      });
    </script>
  </body>
</html>
