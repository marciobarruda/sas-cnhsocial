<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAS ‚Ä¢ CNH Social</title>

    <link
      rel="icon"
      href="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --brand-success: #16b364;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
        --shadow-strong: 0 14px 30px rgba(0, 35, 79, 0.15);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      .page-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }

      .card-programa {
        border: 1px solid rgba(0, 83, 164, 0.08);
        background: var(--surface-strong);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.18);
        border-radius: 1.25rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-strong);
        margin-bottom: 0;
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .institucional-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        background: rgba(0, 83, 164, 0.06);
        color: var(--brand-secondary);
      }

      .institucional-pill-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--brand-highlight);
      }

      .modal-backdrop-custom {
        background: radial-gradient(
          circle at top,
          rgba(0, 83, 164, 0.18),
          rgba(0, 0, 0, 0.55)
        );
      }

      .modal-dialog.modal-lg {
        max-width: 1280px;
        width: min(96vw, 1280px);
      }

      .modal.fade .modal-dialog {
        transform: translateY(12px) scale(0.98);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      }

      .modal.fade.show .modal-dialog {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      .modal-logo {
        max-width: 120px;
        height: auto;
        display: inline-block;
      }

      .form-control:focus {
        border-color: var(--brand-highlight);
        box-shadow: 0 0 0 0.2rem rgba(0, 163, 255, 0.25);
      }

      .logo {
        max-width: 200px;
        height: auto;
      }

      .status-progress {
        background: #f7fbff;
        border: 1px solid rgba(0, 83, 164, 0.08);
        border-radius: 1.25rem;
        padding: 1rem 1.25rem 0.75rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }

      .status-steps {
        display: flex;
        align-items: flex-start;
        gap: 0;
        width: 100%;
        min-width: 0;
      }

      .status-step {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 0.45rem;
        position: relative;
        min-width: 80px;
        padding: 0;
      }

      .status-node {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        background: #fff;
        display: grid;
        place-items: center;
        color: var(--text-muted);
        font-size: 1.25rem;
        font-weight: 700;
        position: relative;
        z-index: 1;
        box-shadow: 0 8px 16px rgba(0, 45, 98, 0.1);
      }

      .status-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        filter: grayscale(1);
        opacity: 0.55;
      }

      .status-check {
        display: none;
        font-size: 1rem;
      }

      .status-label {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-muted);
        line-height: 1.3;
      }

      .status-connector {
        height: 6px;
        background: #e3e8f0;
        flex: 1 1 50px;
        min-width: 32px;
        border-radius: 999px;
        position: relative;
        align-self: flex-start;
        margin: 20px -23px 0;
      }

      .status-connector-active {
        background: linear-gradient(90deg, var(--brand-success), var(--brand-highlight));
        box-shadow: 0 4px 10px rgba(22, 179, 100, 0.15);
      }

      .status-completed .status-node {
        background: var(--brand-success);
        border-color: var(--brand-success);
        color: #fff;
        box-shadow: 0 0 0 6px rgba(22, 179, 100, 0.15);
      }

      .status-completed .status-icon {
        display: none;
      }

      .status-completed .status-check {
        display: inline;
      }

      .status-completed .status-label {
        color: var(--brand-secondary);
      }

      .status-current .status-node {
        background: #fff;
        border-color: var(--brand-highlight);
        color: var(--brand-highlight);
        box-shadow: 0 0 0 6px rgba(0, 163, 255, 0.18);
      }

      .status-current .status-label {
        color: var(--text-strong);
      }

      .status-current .status-icon {
        filter: none;
        opacity: 1;
      }

      .status-pending .status-node {
        background: #fff;
        border-color: var(--border-color);
        color: var(--border-color);
        box-shadow: 0 2px 6px rgba(0, 35, 79, 0.05);
      }

      @media (max-width: 768px) {
        .modal-dialog.modal-lg {
          width: 100%;
        }

        .status-steps {
          gap: 0.4rem;
        }

        .status-step {
          min-width: 100px;
        }
      }

      @media (min-width: 768px) {
        .page-wrapper {
          padding: 3rem 1.5rem;
        }
      }
    </style>
  </head>

  <body>
    <main class="page-wrapper">
      <div class="container" style="max-width: 720px">
        <div class="card card-programa border-0 p-4 p-md-5">
          <div class="text-center mb-4">
            <img
              src="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
              alt="CNH Social Recife"
              class="logo"
            />
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="section-title">Consultar inscri√ß√£o</h1>
            <span class="institucional-pill">
              <span class="institucional-pill-dot"></span>
              Informe seu CPF para continuar
            </span>
          </div>

          <form id="consulta-form" novalidate>
            <div class="mb-3">
              <label for="cpf" class="form-label">CPF</label>
              <input
                type="text"
                inputmode="numeric"
                pattern="\d{11}"
                maxlength="11"
                class="form-control form-control-lg"
                id="cpf"
                name="cpf"
                placeholder="Digite apenas n√∫meros"
                required
              />
              <div class="form-text">Digite os 11 n√∫meros do seu CPF.</div>
              <div class="invalid-feedback" id="cpf-feedback">
                Informe um CPF v√°lido com 11 d√≠gitos num√©ricos.
              </div>
            </div>

            <div class="d-grid d-md-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg px-4">
                Consultar inscri√ß√£o
              </button>
              <a
                class="btn btn-outline-secondary btn-lg px-4"
                href="https://cnhsocial.recife.pe.gov.br/"
              >
                Voltar para o site
              </a>
            </div>
          </form>
        </div>
      </div>
    </main>

    <div
      class="modal fade"
      id="avisoModal"
      tabindex="-1"
      aria-labelledby="avisoModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-4 card-programa">
          <div class="modal-body p-4 p-md-5">
            <div class="d-flex flex-column gap-3">
              <div class="text-center mb-2">
                <img
                  src="https://cnhsocial.recife.pe.gov.br/wp-content/uploads/2025/12/CNH-Recife-Logo.png"
                  alt="CNH Social Recife"
                  class="modal-logo"
                />
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="section-title" id="avisoModalLabel">
                  Processamento da inscri√ß√£o
                </h2>
              </div>

              <span class="institucional-pill">
                <span class="institucional-pill-dot"></span>
                Detalhamento
              </span>

              <div class="status-progress d-none" id="status-progresso" aria-live="polite">
                <div class="status-steps" id="status-steps"></div>
              </div>

              <p class="mb-1 mt-2 fs-6 text-muted" id="mensagem-inscricao">
                <strong>
                  Consultando inscri√ß√£o ativa para o CPF
                  <span id="cpf-mascarado"></span>
                  no programa CNH Social Recife...
                </strong>
              </p>

              <div class="d-flex justify-content-end gap-2 mt-2">
                <button class="btn btn-outline-secondary" id="fechar-modal">
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("consulta-form");
        const cpfInput = document.getElementById("cpf");
        const feedbackCpf = document.getElementById("cpf-feedback");
        const mensagemInscricao = document.getElementById("mensagem-inscricao");
        const cpfSpan = document.getElementById("cpf-mascarado");
        const modalElement = document.getElementById("avisoModal");
        const modal = new bootstrap.Modal(modalElement, {
          backdrop: "static",
          keyboard: false,
        });
        const barraStatus = document.getElementById("status-progresso");
        const stepsContainer = document.getElementById("status-steps");

        const fluxoStatus = [
          {
            chave: "inscricao-processamento",
            rotulo: "Inscri√ß√£o em processamento",
            icone: "üì•",
          },
          {
            chave: "analise-inscricao",
            rotulo: "An√°lise de inscri√ß√£o",
            icone: "üìÑ",
          },
          {
            chave: "analise-recurso",
            rotulo: "An√°lise de recurso",
            icone: "üîÅ",
          },
          {
            chave: "analise-rede-protecao",
            rotulo: "An√°lise Rede de Prote√ß√£o",
            icone: "üõ°Ô∏è",
          },
          {
            chave: "analise-sociofamiliar",
            rotulo: "An√°lise Sociofamiliar",
            icone: "üë®‚Äçüë©‚Äçüëß",
          },
          {
            chave: "analise-socioassistencial",
            rotulo: "An√°lise Socioassistencial",
            icone: "ü§ù",
          },
          {
            chave: "analise-socioocupacional",
            rotulo: "An√°lise Socioocupacional",
            icone: "üíº",
          },
          {
            chave: "analise-dependencia-terapeutica",
            rotulo: "An√°lise depend√™ncia terap√™utica",
            icone: "üß†",
          },
        ];

        const statusAliases = {
          "inscricao em processamento": "Inscri√ß√£o em processamento",
          "recebe dados do front": "Inscri√ß√£o em processamento",
          "analise inscricao": "An√°lise de inscri√ß√£o",
          "analise de inscricao": "An√°lise de inscri√ß√£o",
          "analise da inscricao": "An√°lise de inscri√ß√£o",
          "analise recurso": "An√°lise de recurso",
          "analise de recurso": "An√°lise de recurso",
          "analise rede de protecao": "An√°lise Rede de Prote√ß√£o",
          "analise rede de protecao social": "An√°lise Rede de Prote√ß√£o",
          "analise sociofamiliar": "An√°lise Sociofamiliar",
          "analise socioassistencial": "An√°lise Socioassistencial",
          "analise socio ocupacional": "An√°lise Socioocupacional",
          "analise socioocupacional": "An√°lise Socioocupacional",
          "analise dependencia terapeutica": "An√°lise depend√™ncia terap√™utica",
          "analise de dependencia terapeutica": "An√°lise depend√™ncia terap√™utica",
          "analisar dependencia terapeutica": "An√°lise depend√™ncia terap√™utica",
        };

        const normalizarStatusTexto = (texto) =>
          texto
            .normalize("NFD")
            .replace(/\p{Diacritic}/gu, "")
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, " ")
            .replace(/\s+/g, " ")
            .trim();

        const identificarStatusNoTexto = (texto) => {
          if (!texto || typeof texto !== "string") return null;
          const normalizado = normalizarStatusTexto(texto);
          if (!normalizado) return null;

          if (statusAliases[normalizado]) {
            return statusAliases[normalizado];
          }

          for (const etapa of fluxoStatus) {
            const etapaNormalizada = normalizarStatusTexto(etapa.rotulo);
            if (normalizado.includes(etapaNormalizada)) {
              return etapa.rotulo;
            }
          }

          return null;
        };

        const construirBarraStatus = () => {
          if (!stepsContainer) return;

          stepsContainer.innerHTML = "";

          fluxoStatus.forEach((etapa, index) => {
            const passo = document.createElement("div");
            passo.className = "status-step status-pending";
            passo.dataset.status = etapa.rotulo;
            passo.innerHTML = `
              <div class="status-node" aria-hidden="true">
                <span class="status-icon">${etapa.icone || index + 1}</span>
                <span class="status-check">‚úì</span>
              </div>
              <div class="status-label">${etapa.rotulo}</div>
            `;
            stepsContainer.appendChild(passo);

            if (index < fluxoStatus.length - 1) {
              const connector = document.createElement("div");
              connector.className = "status-connector";
              stepsContainer.appendChild(connector);
            }
          });
        };

        const limparEstadoBarra = () => {
          if (!stepsContainer) return;
          stepsContainer
            .querySelectorAll(".status-step")
            .forEach((step) =>
              step.classList.remove(
                "status-completed",
                "status-current",
                "status-pending"
              )
            );
          stepsContainer
            .querySelectorAll(".status-connector")
            .forEach((connector) =>
              connector.classList.remove("status-connector-active")
            );
        };

        const atualizarBarraStatus = (statusTexto) => {
          if (!barraStatus || !stepsContainer) return;
          const statusIdentificado = identificarStatusNoTexto(statusTexto);

          if (!statusIdentificado) {
            barraStatus.classList.add("d-none");
            return;
          }

          barraStatus.classList.remove("d-none");
          limparEstadoBarra();

          const steps = stepsContainer.querySelectorAll(".status-step");
          let encontrouStatus = false;

          steps.forEach((step) => {
            const rotulo = step.dataset.status;

            if (encontrouStatus) {
              step.classList.add("status-pending");
              return;
            }

            if (rotulo === statusIdentificado) {
              step.classList.add("status-current");
              encontrouStatus = true;
            } else {
              step.classList.add("status-completed");
            }
          });

          const connectors = stepsContainer.querySelectorAll(".status-connector");
          connectors.forEach((connector, index) => {
            const step = steps[index];
            const ativo =
              step?.classList.contains("status-completed") ||
              step?.classList.contains("status-current");
            if (ativo) {
              connector.classList.add("status-connector-active");
            }
          });
        };

        construirBarraStatus();

        modalElement.addEventListener("shown.bs.modal", () => {
          modalElement.classList.add("show");
        });

        const sanitizeHtml = (texto) =>
          texto
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");

        const formatarMarkdownSimples = (texto) => {
          const seguro = sanitizeHtml(texto);
          return seguro
            .replace(/^\s*[-‚Ä¢]\s+/gm, "‚Ä¢ ")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\n/g, "<br>");
        };

        const extrairMensagemSesuite = (payload) => {
          if (typeof payload === "string") {
            return payload.trim();
          }

          if (Array.isArray(payload) && payload.length > 0) {
            return (
              payload[0]?.mensagem ||
              payload[0]?.message ||
              payload[0]?.descricao ||
              "Inscri√ß√£o ativa localizada para o CPF informado."
            );
          }

          return (
            payload?.mensagem ||
            payload?.message ||
            payload?.descricao ||
            "Inscri√ß√£o ativa localizada para o CPF informado."
          );
        };

        const mascararCpf = (cpf) => {
          if (cpf.length === 11) {
            const primeiros3 = cpf.slice(0, 3);
            const ultimos2 = cpf.slice(-2);
            return `${primeiros3}.***.***-${ultimos2}`;
          }
          return "n√£o identificado";
        };

        const extrairStatusDaResposta = (
          payloadInscricao,
          retornoSesuite,
          mensagemPrincipal
        ) => {
          const candidatos = [];
          const adicionar = (valor) => {
            if (valor && typeof valor === "string") {
              candidatos.push(valor);
            }
          };

          if (payloadInscricao && typeof payloadInscricao === "object") {
            adicionar(payloadInscricao.status);
            adicionar(payloadInscricao.situacao);
            adicionar(payloadInscricao.status_inscricao);
            adicionar(payloadInscricao.situacao_inscricao);
            adicionar(payloadInscricao.atividadeAtual);

            if (Array.isArray(payloadInscricao)) {
              payloadInscricao.forEach((item) => {
                adicionar(item?.status);
                adicionar(item?.situacao);
              });
            }
          }

          if (retornoSesuite && typeof retornoSesuite === "object") {
            adicionar(retornoSesuite.status);
            adicionar(retornoSesuite.situacao);
            adicionar(retornoSesuite.status_inscricao);
            adicionar(retornoSesuite.situacao_inscricao);
          } else if (typeof retornoSesuite === "string") {
            adicionar(retornoSesuite);
          }

          adicionar(mensagemPrincipal);

          for (const candidato of candidatos) {
            const identificado = identificarStatusNoTexto(candidato);
            if (identificado) {
              return identificado;
            }
          }

          return null;
        };

        const atualizarCpfMascarado = (cpfNumeros) => {
          if (cpfSpan) {
            cpfSpan.textContent = mascararCpf(cpfNumeros);
          }
        };

        const definirMensagemInicial = (cpfNumeros) => {
          mensagemInscricao.innerHTML = `<strong>Consultando inscri√ß√£o ativa para o CPF ${mascararCpf(
            cpfNumeros
          )} no programa CNH Social Recife...</strong>`;
        };

        const consultarInscricao = async (cpfNumeros) => {
          if (!cpfNumeros) {
            mensagemInscricao.textContent =
              "N√£o foi poss√≠vel identificar o CPF para consulta.";
            return;
          }

          const enviarParaSesuite = async (dadosInscricao) => {
            const respostaSesuite = await fetch(
              "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/consultar-cnh-sesuite",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(dadosInscricao),
              }
            );

            if (!respostaSesuite.ok) {
              throw new Error(`Erro ao consultar SESuite: ${respostaSesuite.status}`);
            }

            const texto = await respostaSesuite.text();
            try {
              return JSON.parse(texto);
            } catch (_erroParsing) {
              return texto.trim();
            }
          };

          try {
            const resposta = await fetch(
              "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/consultar-inscricao-por-cpf",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ cpfNumeros }),
              }
            );

            if (!resposta.ok) {
              throw new Error(`Erro na consulta: ${resposta.status}`);
            }

            const payloadInscricao = await resposta.json();

            try {
              const retornoSesuite = await enviarParaSesuite(payloadInscricao);
              const mensagemPrincipal = extrairMensagemSesuite(retornoSesuite);

              const statusIdentificado = extrairStatusDaResposta(
                payloadInscricao,
                retornoSesuite,
                mensagemPrincipal
              );

              const mensagemFormatada = formatarMarkdownSimples(mensagemPrincipal);

              atualizarBarraStatus(statusIdentificado || fluxoStatus[0]?.rotulo);
              mensagemInscricao.innerHTML = `<strong>${mensagemFormatada}</strong>`;
            } catch (erroSesuite) {
              atualizarBarraStatus(null);
              mensagemInscricao.innerHTML =
                "<strong>N√£o foi poss√≠vel recuperar a situa√ß√£o da inscri√ß√£o no momento.</strong>";
            }
          } catch (erro) {
            atualizarBarraStatus(null);
            mensagemInscricao.innerHTML =
              "<strong>N√£o foi poss√≠vel recuperar sua inscri√ß√£o no momento.</strong>";
          }
        };

        const normalizarCpf = (valor) => valor.replace(/\D/g, "").slice(0, 11);

        cpfInput.addEventListener("input", (event) => {
          const apenasNumeros = normalizarCpf(event.target.value);
          event.target.value = apenasNumeros;
          if (apenasNumeros.length === 11) {
            cpfInput.classList.remove("is-invalid");
          }
        });

        form.addEventListener("submit", (event) => {
          event.preventDefault();

          const cpfNormalizado = normalizarCpf(cpfInput.value);

          if (cpfNormalizado.length !== 11) {
            cpfInput.classList.add("is-invalid");
            if (feedbackCpf) {
              feedbackCpf.textContent =
                "Informe um CPF v√°lido com 11 d√≠gitos num√©ricos.";
            }
            cpfInput.focus();
            return;
          }

          cpfInput.classList.remove("is-invalid");
          atualizarCpfMascarado(cpfNormalizado);
          definirMensagemInicial(cpfNormalizado);
          atualizarBarraStatus(fluxoStatus[0]?.rotulo);
          modal.show();
          consultarInscricao(cpfNormalizado);
        });

        const fecharBtn = document.getElementById("fechar-modal");
        if (fecharBtn) {
          fecharBtn.addEventListener("click", () => {
            window.location.href = "https://cnhsocial.recife.pe.gov.br/";
          });
        }
      });
    </script>
  </body>
</html>
